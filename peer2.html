<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peer 2 - WebRTC Demo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”µ Peer 2</h1>
      <div class="status" id="status">Disconnected</div>
    </div>

    <div class="info-box">
      <h3>ğŸ”„ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WebRTC:</h3>
      <div class="explanation">
        <ol>
          <li><strong>Signalling Phase:</strong>
            <ul>
              <li>Peer1 à¸ªà¸£à¹‰à¸²à¸‡ Offer (SDP) à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸™ Signalling Server</li>
              <li>Peer2 à¹„à¸”à¹‰à¸£à¸±à¸š Offer à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡ Answer à¸à¸¥à¸±à¸šà¹„à¸›</li>
              <li>à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ ICE Candidates à¸œà¹ˆà¸²à¸™ Signalling Server</li>
            </ul>
          </li>
          <li><strong>ICE Gathering:</strong>
            <ul>
              <li>à¹à¸•à¹ˆà¸¥à¸° peer à¹ƒà¸Šà¹‰ STUN server à¸«à¸² public IP</li>
              <li>à¸ªà¸£à¹‰à¸²à¸‡ candidates: host (local), srflx (STUN), relay (TURN)</li>
              <li>à¸ªà¹ˆà¸‡ candidates à¹„à¸›à¹ƒà¸«à¹‰à¸­à¸µà¸ peer à¸œà¹ˆà¸²à¸™ Signalling</li>
            </ul>
          </li>
          <li><strong>Connection Establishment:</strong>
            <ul>
              <li>à¸¥à¸­à¸‡ connect à¸œà¹ˆà¸²à¸™ candidate à¸•à¹ˆà¸²à¸‡à¹†</li>
              <li>à¹€à¸¥à¸·à¸­à¸ path à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” (à¹‚à¸”à¸¢à¸›à¸à¸•à¸´à¹€à¸¥à¸·à¸­à¸ direct P2P)</li>
              <li>à¸–à¹‰à¸² P2P à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸ˆà¸°à¹ƒà¸Šà¹‰ TURN relay</li>
            </ul>
          </li>
          <li><strong>Data Transfer:</strong>
            <ul>
              <li>à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸‡à¸•à¸£à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ peer</li>
              <li>Signalling Server à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡</li>
              <li>à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸”à¹‰à¸§à¸¢ DTLS encryption</li>
            </ul>
          </li>
        </ol>
      </div>
    </div>

    <div class="peers-section">
      <h3>Available Peers:</h3>
      <div id="peersList"></div>
    </div>

    <div class="connection-info" id="connectionInfo"></div>

    <div class="chat-box">
      <div class="messages" id="messages"></div>
      <div class="input-group">
        <input type="text" id="messageInput" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡..." disabled>
        <button id="sendBtn" disabled>à¸ªà¹ˆà¸‡</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PEER 2 - WebRTC Client Side
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: à¹‚à¸„à¹‰à¸”à¸‚à¸­à¸‡ Peer2 à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸š Peer1 à¹€à¸à¸·à¸­à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    // à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¹à¸„à¹ˆ PEER_ID à¹à¸¥à¸° UI à¸­à¸˜à¸´à¸šà¸²à¸¢
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. à¸•à¸±à¸§à¹à¸›à¸£à¸à¸·à¹‰à¸™à¸à¸²à¸™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PEER_ID = 'peer2';              // à¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡ peer à¸™à¸µà¹‰ (à¸•à¹ˆà¸²à¸‡à¸ˆà¸²à¸ peer1)
    const socket = io();                   // à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Socket.io à¸à¸±à¸š Signalling Server
    let peerConnection = null;             // RTCPeerConnection - à¸«à¸±à¸§à¹ƒà¸ˆà¸‚à¸­à¸‡ WebRTC
    let dataChannel = null;                // RTCDataChannel - à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    let remotePeerId = null;               // à¹€à¸à¹‡à¸šà¸Šà¸·à¹ˆà¸­ peer à¸—à¸µà¹ˆà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸”à¹‰à¸§à¸¢

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. WebRTC Configuration
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // à¸à¸³à¸«à¸™à¸” STUN servers à¹€à¸à¸·à¹ˆà¸­à¸«à¸² public IP address
    const configuration = {
      iceServers: [
        {
          urls: 'stun:stun.l.google.com:19302'    // Google STUN server (à¸Ÿà¸£à¸µ)
        },
        {
          urls: 'stun:stun1.l.google.com:19302'   // STUN server à¸ªà¸³à¸£à¸­à¸‡
        }
      ]
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. DOM Elements References
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const peersListEl = document.getElementById('peersList');
    const connectionInfoEl = document.getElementById('connectionInfo');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. Socket.io Events - Signalling Phase
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.1 à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š Signalling Server à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('connect', () => {
      statusEl.textContent = 'Connected to Signalling Server';
      statusEl.className = 'status connected';
      socket.emit('register', PEER_ID);  // à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹€à¸›à¹‡à¸™ 'peer2'
      addMessage('System', 'à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Signalling Server à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'system');
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.2 à¸£à¸±à¸šà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­ Peers à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('peers-list', (peers) => {
      updatePeersList(peers);
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.3 à¸¡à¸µ Peer à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸²
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('peer-joined', (peerId) => {
      addMessage('System', `${peerId} à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡`, 'system');
      const btn = document.createElement('button');
      btn.textContent = `Connect to ${peerId}`;
      btn.onclick = () => connectToPeer(peerId);
      peersListEl.appendChild(btn);
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.4 Peer à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('peer-left', (peerId) => {
      addMessage('System', `${peerId} à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š`, 'system');
      updatePeersList([]);
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.5 à¸£à¸±à¸š Offer à¸ˆà¸²à¸ Peer à¸­à¸·à¹ˆà¸™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // à¸™à¸µà¹ˆà¸„à¸·à¸­à¸ªà¹ˆà¸§à¸™à¸ªà¸³à¸„à¸±à¸! à¹€à¸¡à¸·à¹ˆà¸­ peer1 à¸ªà¹ˆà¸‡ offer à¸¡à¸² à¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸”à¹‰à¸§à¸¢ answer
    socket.on('offer', async (data) => {
      try {
        addMessage('System', `à¹„à¸”à¹‰à¸£à¸±à¸š Offer à¸ˆà¸²à¸ ${data.from}`, 'system');
        
        // à¸›à¸´à¸” connection à¹€à¸à¹ˆà¸² (à¸–à¹‰à¸²à¸¡à¸µ)
        if (peerConnection) {
          addMessage('System', 'à¸›à¸´à¸” connection à¹€à¸à¹ˆà¸²...', 'system');
          peerConnection.close();
          peerConnection = null;
        }
        
        remotePeerId = data.from;
        
        // à¸ªà¸£à¹‰à¸²à¸‡ peer connection (à¸à¹ˆà¸²à¸¢à¸•à¸­à¸šà¸£à¸±à¸š)
        await createPeerConnection(false);
        
        // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Remote Description à¸ˆà¸²à¸ offer
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        
        // à¸ªà¸£à¹‰à¸²à¸‡ Answer
        const answer = await peerConnection.createAnswer();
        
        // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Local Description à¹€à¸›à¹‡à¸™ answer
        await peerConnection.setLocalDescription(answer);
        
        // à¸ªà¹ˆà¸‡ answer à¸à¸¥à¸±à¸šà¹„à¸›à¸œà¹ˆà¸²à¸™ Signalling Server
        socket.emit('answer', {
          answer: answer,
          target: data.from,
          from: PEER_ID
        });
        
        addMessage('System', `à¸ªà¹ˆà¸‡ Answer à¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡ ${data.from}`, 'system');
      } catch (error) {
        addMessage('System', `âŒ Error handling offer: ${error.message}`, 'system');
        console.error('Error in offer handler:', error);
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.6 à¸£à¸±à¸š Answer à¸ˆà¸²à¸ Peer à¸­à¸·à¹ˆà¸™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('answer', async (data) => {
      addMessage('System', `à¹„à¸”à¹‰à¸£à¸±à¸š Answer à¸ˆà¸²à¸ ${data.from}`, 'system');
      // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Remote Description - à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸™à¸µà¹‰ WebRTC à¸ˆà¸°à¹€à¸£à¸´à¹ˆà¸¡à¸«à¸²à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4.7 à¸£à¸±à¸š ICE Candidate
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('ice-candidate', async (data) => {
      if (peerConnection && data.candidate) {
        // à¹€à¸à¸´à¹ˆà¸¡ candidate à¹€à¸‚à¹‰à¸²à¹„à¸› WebRTC à¸ˆà¸°à¸¥à¸­à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸œà¹ˆà¸²à¸™à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸™à¸µà¹‰
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        addMessage('System', `à¹€à¸à¸´à¹ˆà¸¡ ICE Candidate à¸ˆà¸²à¸ ${data.from}`, 'system');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5. Helper Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5.1 à¸­à¸±à¸à¹€à¸”à¸•à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­ Peers
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updatePeersList(peers) {
      peersListEl.innerHTML = '';  // à¸¥à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹€à¸à¹ˆà¸²
      peers.forEach(peerId => {
        const btn = document.createElement('button');
        btn.textContent = `Connect to ${peerId}`;
        btn.onclick = () => connectToPeer(peerId);
        peersListEl.appendChild(btn);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5.2 à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š Peer à¸­à¸·à¹ˆà¸™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function connectToPeer(peerId) {
      // à¸›à¸´à¸” connection à¹€à¸à¹ˆà¸² (à¸–à¹‰à¸²à¸¡à¸µ)
      if (peerConnection) {
        addMessage('System', 'à¸¡à¸µ connection à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§ à¸à¸³à¸¥à¸±à¸‡à¸›à¸´à¸” connection à¹€à¸à¹ˆà¸²...', 'system');
        peerConnection.close();
        peerConnection = null;
      }
      
      remotePeerId = peerId;
      addMessage('System', `à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š ${peerId}...`, 'system');
      
      // à¸ªà¸£à¹‰à¸²à¸‡ connection à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸à¹ˆà¸²à¸¢à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ (à¸ªà¹ˆà¸‡ offer)
      await createPeerConnection(true);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6. à¸ªà¸£à¹‰à¸²à¸‡ WebRTC Peer Connection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ WebRTC
    async function createPeerConnection(isInitiator) {
      // à¸ªà¸£à¹‰à¸²à¸‡ RTCPeerConnection à¸à¸£à¹‰à¸­à¸¡ STUN configuration
      peerConnection = new RTCPeerConnection(configuration);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 6.1 Event: onicecandidate - à¸ªà¹ˆà¸‡ ICE candidates
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // à¹€à¸¡à¸·à¹ˆà¸­ WebRTC à¸«à¸²à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰ à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ peer à¸­à¸·à¹ˆà¸™
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('ice-candidate', {
            candidate: event.candidate,
            target: remotePeerId,
            from: PEER_ID
          });
          addMessage('System', 'à¸ªà¹ˆà¸‡ ICE Candidate', 'system');
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 6.2 Event: onconnectionstatechange - à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      peerConnection.onconnectionstatechange = () => {
        const state = peerConnection.connectionState;
        connectionInfoEl.innerHTML = `<strong>Connection State:</strong> ${state}`;
        addMessage('System', `Connection State: ${state}`, 'system');
        
        if (state === 'connected') {
          addMessage('System', 'âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ P2P à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¸•à¸­à¸™à¸™à¸µà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸‡à¸•à¸£à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ peer', 'system');
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 6.3 Event: oniceconnectionstatechange
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      peerConnection.oniceconnectionstatechange = () => {
        const state = peerConnection.iceConnectionState;
        addMessage('System', `ICE Connection State: ${state}`, 'system');
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 6.4 à¹à¸¢à¸à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡ Role
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (isInitiator) {
        // à¸à¹ˆà¸²à¸¢à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™: à¸ªà¸£à¹‰à¸²à¸‡ data channel à¹à¸¥à¸°à¸ªà¹ˆà¸‡ offer
        dataChannel = peerConnection.createDataChannel('chat');
        setupDataChannel();
        
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('offer', {
          offer: offer,
          target: remotePeerId,
          from: PEER_ID
        });
        addMessage('System', `à¸ªà¹ˆà¸‡ Offer à¹„à¸›à¸¢à¸±à¸‡ ${remotePeerId}`, 'system');
      } else {
        // à¸à¹ˆà¸²à¸¢à¸•à¸­à¸šà¸£à¸±à¸š: à¸£à¸­à¸£à¸±à¸š data channel
        peerConnection.ondatachannel = (event) => {
          dataChannel = event.channel;
          setupDataChannel();
        };
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Data Channel Events
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setupDataChannel() {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 7.1 Event: onopen - Data Channel à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      dataChannel.onopen = () => {
        addMessage('System', 'âœ… Data Channel à¹€à¸›à¸´à¸”à¹à¸¥à¹‰à¸§ - à¸à¸£à¹‰à¸­à¸¡à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡!', 'system');
        
        // à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸Šà¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œà¹à¸¥à¸°à¸›à¸¸à¹ˆà¸¡à¸ªà¹ˆà¸‡
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.focus();
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 7.2 Event: onclose - Data Channel à¸›à¸´à¸”
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      dataChannel.onclose = () => {
        addMessage('System', 'Data Channel à¸›à¸´à¸”à¹à¸¥à¹‰à¸§', 'system');
        messageInput.disabled = true;
        sendBtn.disabled = true;
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 7.3 Event: onmessage - à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸ peer à¸­à¸·à¹ˆà¸™
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      dataChannel.onmessage = (event) => {
        // à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¹ˆà¸‡à¸¡à¸²à¸•à¸£à¸‡ P2P à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™ server!
        addMessage(remotePeerId, event.data, 'received');
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 8. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sendMessage() {
      const message = messageInput.value.trim();
      
      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸¥à¸° channel à¸à¸£à¹‰à¸­à¸¡à¸ªà¹ˆà¸‡
      if (message && dataChannel && dataChannel.readyState === 'open') {
        // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸œà¹ˆà¸²à¸™ Data Channel (P2P à¹‚à¸”à¸¢à¸•à¸£à¸‡)
        dataChannel.send(message);
        
        // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸£à¸²à¸ªà¹ˆà¸‡
        addMessage('You', message, 'sent');
        
        // à¸¥à¹‰à¸²à¸‡à¸Šà¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ
        messageInput.value = '';
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 8.1 Event Listeners à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    sendBtn.onclick = sendMessage;  // à¸„à¸¥à¸´à¸à¸›à¸¸à¹ˆà¸¡à¸ªà¹ˆà¸‡
    
    messageInput.onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();  // à¸à¸” Enter
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 9. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸™ UI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addMessage(sender, message, type) {
      const msgEl = document.createElement('div');
      msgEl.className = `message ${type}`;
      msgEl.innerHTML = `<strong>${sender}:</strong> ${message}`;
      messagesEl.appendChild(msgEl);
      
      // à¹€à¸¥à¸·à¹ˆà¸­à¸™ scroll à¸¥à¸‡à¸¥à¹ˆà¸²à¸‡à¸ªà¸¸à¸”
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
